<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AR Navigator Pro - iPhone</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      :root { 
        --safe-top: env(safe-area-inset-top); 
        --safe-bottom: env(safe-area-inset-bottom); 
      }
      
      body { 
        margin: 0; 
        overflow: hidden; 
        font-family: -apple-system, system-ui, sans-serif; 
        background-color: #000; 
      }
      
      /* Buscador Superior Sticky */
      .ui-top { 
        position: fixed; 
        top: 0; 
        left: 0;
        right: 0;
        z-index: 1000; 
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(15px);
        padding-top: var(--safe-top);
        padding-bottom: 15px;
        display: flex;
        justify-content: center;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .search-box { 
        display: flex; 
        width: 94%;
        background: rgba(255, 255, 255, 0.15); 
        padding: 8px; 
        border-radius: 16px; 
      }
      
      input { 
        flex: 1; 
        background: transparent; 
        border: none; 
        color: white; 
        padding: 12px; 
        font-size: 20px; 
        font-weight: 500;
        outline: none; 
      }

      button { 
        background: #007AFF; 
        color: white; 
        border: none; 
        border-radius: 12px; 
        padding: 0 20px; 
        font-weight: 800; 
        font-size: 18px; 
        text-transform: uppercase;
      }

      /* Flecha Guía */
      .ui-middle {
        position: fixed;
        bottom: calc(180px + var(--safe-bottom));
        left: 50%;
        transform: translateX(-50%);
        z-index: 900;
        pointer-events: none;
      }

      #arrow-svg { 
        width: 140px; 
        height: 140px; 
        will-change: transform;
        transition: transform 0.05s linear;
      }

      /* Panel de Coordenadas Inferior */
      .ui-bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(20px);
        padding-bottom: calc(15px + var(--safe-bottom));
        padding-top: 15px;
        border-top: 2px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .coord-row {
        width: 92%;
        display: flex;
        justify-content: space-between;
        font-size: 14px; 
        font-weight: 600;
        color: #ccc;
      }

      .coord-val { 
        color: #00D2FF; 
        font-family: monospace; 
        font-size: 16px; 
        font-weight: bold;
      }

      .dist-badge {
        background: #34C759;
        color: white;
        padding: 10px 30px; 
        border-radius: 18px;
        font-weight: 900;
        font-size: 24px; 
        margin-top: 8px;
        box-shadow: 0 4px 20px rgba(52, 199, 89, 0.4);
      }
    </style>
  </head>

  <body>
    <div class="ui-top">
      <div class="search-box">
        <input type="text" id="placeName" placeholder="¿A dónde quieres ir?" onfocus="this.value=''" spellcheck="false">
        <button onclick="buscarLugar()">BUSCAR</button>
      </div>
    </div>

    <div class="ui-middle" id="guideUI" style="visibility: hidden;">
      <svg id="arrow-svg" viewBox="0 0 100 100">
        <path id="arrow-path" d="M50 5 L95 95 L50 75 L5 95 Z" fill="#888" stroke="white" stroke-width="2"/>
      </svg>
    </div>

    <div class="ui-bottom">
      <div class="coord-row">
        <span>MI UBICACIÓN:</span>
        <span id="my-coords" class="coord-val">LOCALIZANDO...</span>
      </div>
      <div class="coord-row">
        <span>DESTINO:</span>
        <span id="dest-coords" class="coord-val">---</span>
      </div>
      <div id="dist-text" class="dist-badge" style="display:none;">0 m</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
    >
      <a-entity id="target-anchor">
        <a-sphere radius="12" color="#00D2FF" opacity="0.6" gps-entity-place="latitude: 0; longitude: 0;"></a-sphere>
        <a-text id="marker-label" value="" look-at="[gps-camera]" scale="90 90 90" position="0 30 0" align="center" color="#00D2FF"></a-text>
      </a-entity>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      let destLat, destLon, currentBearing = 0;
      const arrow = document.getElementById('arrow-svg');
      const arrowPath = document.getElementById('arrow-path');
      const myCoordsText = document.getElementById('my-coords');
      const destCoordsText = document.getElementById('dest-coords');
      const distBadge = document.getElementById('dist-text');

      async function buscarLugar() {
        const query = document.getElementById('placeName').value;
        if (!query) return;

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
          const data = await res.json();

          if (data.length > 0) {
            destLat = parseFloat(data[0].lat);
            destLon = parseFloat(data[0].lon);
            
            destCoordsText.innerText = `${destLat.toFixed(5)}, ${destLon.toFixed(5)}`;
            document.getElementById('target-anchor').children[0].setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLon};`);
            document.getElementById('marker-label').setAttribute('value', data[0].display_name.split(',')[0].toUpperCase());
            
            document.getElementById('guideUI').style.visibility = 'visible';
            distBadge.style.display = 'block';
            solicitarPermisos();
          }
        } catch (e) { console.error("Error en la API", e); }
      }

      function solicitarPermisos() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(s => {
            if(s === 'granted') window.addEventListener('deviceorientation', updateUI, true);
          });
        } else {
          window.addEventListener('deviceorientation', updateUI, true);
        }
        iniciarGPS();
      }

      function updateUI(e) {
        if (!destLat) return;
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        let diff = (currentBearing - heading + 360) % 360;
        let rotation = diff > 180 ? diff - 360 : diff;

        const error = Math.abs(rotation);
        let scale = 1, color = "#888";

        if (error < 30) {
          scale = error < 10 ? 1.45 : 1.25;
          color = error < 10 ? "#00D2FF" : "#34C759";
          if (error < 5) window.navigator.vibrate(25);
        }

        arrow.style.transform = `rotate(${rotation}deg) scale(${scale}) translateZ(0)`;
        arrowPath.setAttribute('fill', color);
      }

      function iniciarGPS() {
        navigator.geolocation.watchPosition((pos) => {
          const uLat = pos.coords.latitude;
          const uLon = pos.coords.longitude;
          myCoordsText.innerText = `${uLat.toFixed(5)}, ${uLon.toFixed(5)}`;
          if(destLat) {
            const y = Math.sin(toRadians(destLon - uLon)) * Math.cos(toRadians(destLat));
            const x = Math.cos(toRadians(uLat)) * Math.sin(toRadians(destLat)) -
                      Math.sin(toRadians(uLat)) * Math.cos(toRadians(destLat)) * Math.cos(toRadians(destLon - uLon));
            currentBearing = (toDegrees(Math.atan2(y, x)) + 360) % 360;
            const d = calcDist(uLat, uLon, destLat, destLon);
            distBadge.innerText = d > 1 ? `${d.toFixed(1)} KM` : `${(d*1000).toFixed(0)} METROS`;
          }
        }, null, { enableHighAccuracy: true });
      }

      function toRadians(d) { return d * Math.PI / 180; }
      function toDegrees(r) { return r * 180 / Math.PI; }
      function calcDist(l1, n1, l2, n2) {
        const R = 6371;
        const dL = toRadians(l2-l1); const dN = toRadians(n2-n1);
        const a = Math.sin(dL/2)**2 + Math.cos(toRadians(l1))*Math.cos(toRadians(l2))*Math.sin(dN/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }
    </script>
  </body>
</html>