<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AR Horizon Scanner - Distance Priority</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
      body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: white; }

      /* HUD Superior */
      .hud-header { 
        position: fixed; top: 0; left: 0; right: 0; z-index: 1000; 
        background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
        padding: calc(20px + var(--safe-top)) 20px 10px;
        text-align: center;
      }
      .radar-line { width: 40%; height: 2px; background: #FF9500; margin: 10px auto; box-shadow: 0 0 15px #FF9500; }
      .radar-label { font-weight: 800; letter-spacing: 4px; font-size: 12px; color: rgba(255,149,0,0.9); }

      /* CONTENEDOR DE RESULTADOS */
      .results-container {
        position: fixed; top: 55%; left: 50%; transform: translate(-50%, -50%);
        width: 85%; z-index: 1000; display: flex; flex-direction: column; gap: 12px;
        pointer-events: none;
      }

      .town-card {
        background: rgba(15, 15, 15, 0.75); backdrop-filter: blur(12px);
        border-left: 6px solid #FF9500; padding: 18px 22px; border-radius: 0 20px 20px 0;
        display: flex; justify-content: space-between; align-items: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 0; transform: translateX(-30px);
      }
      
      .town-card.visible { opacity: 1; transform: translateX(0); }

      .town-info h2 { margin: 0; font-size: 24px; font-weight: 900; color: #FF9500; text-transform: uppercase; }
      .town-info p { margin: 3px 0 0; font-size: 11px; color: #888; font-weight: 700; letter-spacing: 1px; }
      
      .distance-tag { font-size: 28px; font-weight: 900; color: white; font-family: 'Courier New', monospace; }
      .km-unit { font-size: 12px; color: #FF9500; margin-left: 2px; }

      /* Punto de mira central */
      .crosshair {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 40px; height: 40px; border: 1px solid rgba(255,149,0,0.4); border-radius: 50%;
        z-index: 500; pointer-events: none;
      }
      .crosshair::after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #FF9500; border-radius: 50%; transform: translate(-50%, -50%); }
    </style>
  </head>

  <body>
    <div class="hud-header">
      <div class="radar-label">PROXIMITY SCANNER</div>
      <div class="radar-line"></div>
    </div>

    <div class="crosshair"></div>
    <div id="results-container" class="results-container"></div>

    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      let databasePueblos = [];
      const container = document.getElementById('results-container');

      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetchPueblos(lat, lon);
        
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission();
        }
        window.addEventListener('deviceorientation', handleOrientation, true);
      });

      async function fetchPueblos(lat, lon) {
        // Radio de 50km para tener un buen rango de búsqueda
        const query = `[out:json];node(around:50000,${lat},${lon})["place"~"city|town|village|hamlet"];out 50;`;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          databasePueblos = data.elements.map(el => ({
            name: el.tags.name ? el.tags.name.toUpperCase() : "NÚCLEO URBANO",
            lat: el.lat,
            lon: el.lon,
            tipo: (el.tags.place || "Pueblo").toUpperCase()
          }));
        } catch (e) { console.error("Error cargando datos de OpenStreetMap"); }
      }

      function handleOrientation(e) {
        if (databasePueblos.length === 0) return;

        let heading = e.webkitCompassHeading || (360 - e.alpha);

        navigator.geolocation.getCurrentPosition((pos) => {
          const uLat = pos.coords.latitude;
          const uLon = pos.coords.longitude;

          const listadoProcesado = databasePueblos.map(p => {
            const y = Math.sin(toRadians(p.lon - uLon)) * Math.cos(toRadians(p.lat));
            const x = Math.cos(toRadians(uLat)) * Math.sin(toRadians(p.lat)) -
                      Math.sin(toRadians(uLat)) * Math.cos(toRadians(p.lat)) * Math.cos(toRadians(p.lon - uLon));
            const bearing = (toDegrees(Math.atan2(y, x)) + 360) % 360;
            const diff = Math.abs((bearing - heading + 540) % 360 - 180);
            const dist = calcDist(uLat, uLon, p.lat, p.lon);
            return { ...p, diff, dist };
          });

          // FILTRO: Solo en dirección de cámara (cono de 30 grados)
          // ORDEN: De menor distancia a mayor distancia (el más cercano primero)
          const ordenadosPorDistancia = listadoProcesado
            .filter(p => p.diff < 15)
            .sort((a, b) => a.dist - b.dist)
            .slice(0, 5);

          renderUI(ordenadosPorDistancia);
        });
      }

      function renderUI(pueblos) {
        container.innerHTML = '';
        pueblos.forEach((p, index) => {
          const card = document.createElement('div');
          card.className = 'town-card visible';
          // Efecto de desvanecimiento según la posición en la lista (más lejos = más transparente)
          card.style.opacity = 1 - (index * 0.15);
          card.style.transitionDelay = `${index * 0.05}s`;
          
          card.innerHTML = `
            <div class="town-info">
              <h2>${p.name}</h2>
              <p>${p.tipo} • EN TU DIRECCIÓN</p>
            </div>
            <div class="distance-tag">${p.dist.toFixed(1)}<span class="km-unit">KM</span></div>
          `;
          container.appendChild(card);
        });
        
        // Vibración corta si el pueblo más cercano está casi perfecto en el centro
        if (pueblos.length > 0 && pueblos[0].diff < 3) {
            window.navigator.vibrate(15);
        }
      }

      function toRadians(d) { return d * Math.PI / 180; }
      function toDegrees(r) { return r * 180 / Math.PI; }
      function calcDist(l1, n1, l2, n2) {
        const R = 6371;
        const dL = toRadians(l2-l1); const dN = toRadians(n2-n1);
        const a = Math.sin(dL/2)**2 + Math.cos(toRadians(l1))*Math.cos(toRadians(l2))*Math.sin(dN/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }
    </script>
  </body>
</html>