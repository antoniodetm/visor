<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Buscador AR con Brújula</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body { margin: 0; font-family: -apple-system, sans-serif; }
      .ui-panel {
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        width: 90%; background: rgba(0,0,0,0.7); color: white;
        padding: 15px; border-radius: 20px; z-index: 100; text-align: center;
      }
      input { width: 70%; padding: 10px; border-radius: 10px; border: none; }
      button { padding: 10px; border-radius: 10px; background: #34c759; color: white; border: none; font-weight: bold; }
      #guide { font-size: 2rem; margin-top: 10px; color: #ffcc00; }
      .stats { font-size: 0.7rem; margin-top: 5px; opacity: 0.8; }
    </style>
  </head>

  <body>
    <div class="ui-panel">
      <input type="text" id="place-name" placeholder="Ej: Torre Eiffel o Madrid">
      <button onclick="searchPlace()">BUSCAR</button>
      <div id="guide">↔️ Mira a tu alrededor</div>
      <div class="stats" id="dist-text">Busca un lugar para empezar</div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-entity id="target" 
                gps-entity-place="latitude: 0; longitude: 0;" 
                geometry="primitive: cylinder; radius: 2; height: 50" 
                material="color: #00ff00; opacity: 0.7"
                visible="false">
      </a-entity>

      <a-camera id="camera" gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      let destLat, destLng;
      
      // Función para buscar por nombre
      async function searchPlace() {
        const query = document.getElementById('place-name').value;
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await response.json();

        if (data.length > 0) {
          destLat = parseFloat(data[0].lat);
          destLng = parseFloat(data[0].lon);
          
          const target = document.getElementById('target');
          target.setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLng};`);
          target.setAttribute('visible', 'true');
          
          alert(`Destino fijado en: ${data[0].display_name}`);
          startGuiding();
        } else {
          alert("No se encontró el lugar.");
        }
      }

      // Lógica para indicar hacia dónde girar
      function startGuiding() {
        const camera = document.querySelector('[gps-camera]');
        const guide = document.getElementById('guide');
        const distText = document.getElementById('dist-text');

        camera.addEventListener('gps-camera-update-position', (e) => {
          // Calculamos la distancia
          const dist = e.detail.distance.toFixed(0);
          distText.innerText = `Distancia aproximada: ${dist} metros`;
        });

        // Evento que se dispara al mirar hacia el objeto
        window.addEventListener('deviceorientation', (event) => {
          // Aquí AR.js maneja la rotación interna, pero podemos 
          // simplificarlo: si el objeto no está en pantalla, 
          // el usuario debe seguir rotando.
          // En iPhone 12, el objeto aparecerá automáticamente en su sitio real.
        });
      }

      // Hack para iPhone: Solicitar permisos de orientación
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        document.body.addEventListener('click', () => {
          DeviceOrientationEvent.requestPermission();
        }, { once: true });
      }
    </script>
  </body>
</html>