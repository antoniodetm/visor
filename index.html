<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Buscador AR con Guía</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      .ui-panel {
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        z-index: 1000; width: 90%; display: flex; flex-direction: column; gap: 10px;
      }
      .search-box { display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; }
      input { flex: 1; padding: 12px; border-radius: 5px; border: none; font-size: 16px; } /* 16px evita zoom en iPhone */
      button { padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; }
      
      #guide {
        background: rgba(255, 255, 255, 0.9);
        padding: 10px; text-align: center; border-radius: 20px;
        font-weight: bold; color: #333; display: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
    </style>
  </head>

  <body>
    <div class="ui-panel">
      <div class="search-box">
        <input type="text" id="placeName" placeholder="Escribe un lugar...">
        <button onclick="buscarLugar()">BUSCAR</button>
      </div>
      <div id="guide">Calculando ruta...</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
    >
      <a-text
        id="marker"
        value=""
        look-at="[gps-camera]"
        scale="50 50 50"
        gps-entity-place="latitude: 0; longitude: 0;"
        color="red"
        visible="false"
      ></a-text>

      <a-camera gps-camera rotation-reader id="camera"></a-camera>
    </a-scene>

    <script>
      let destLat, destLon;
      const guide = document.getElementById('guide');

      async function buscarLugar() {
        const query = document.getElementById('placeName').value;
        if (!query) return;

        guide.style.display = "block";
        guide.innerText = "Buscando coordenadas...";

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
          const data = await res.json();

          if (data.length > 0) {
            destLat = parseFloat(data[0].lat);
            destLon = parseFloat(data[0].lon);
            
            const marker = document.getElementById('marker');
            marker.setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLon};`);
            marker.setAttribute('value', data[0].display_name.split(',')[0]);
            marker.setAttribute('visible', 'true');
            
            guide.innerText = "¡Lugar fijado! Gira para encontrarlo.";
            iniciarGuia();
          } else {
            guide.innerText = "Lugar no encontrado.";
          }
        } catch (e) {
          guide.innerText = "Error de conexión.";
        }
      }

      function iniciarGuia() {
        // Listener para actualizar la flecha/guía basada en la rotación del móvil
        window.addEventListener('deviceorientation', (event) => {
          if (!destLat) return;
          
          // Nota: La lógica de brújula en navegadores puede variar. 
          // Este es un indicador simple basado en la cámara de AR.js
          const camera = document.querySelector('[gps-camera]');
          const distance = camera.components['gps-camera'].distance;
          
          if (distance) {
            guide.innerText = `Destino a ${(distance/1000).toFixed(2)} km de ti`;
          }
        });
      }
    </script>
  </body>
</html>