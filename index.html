<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Localizador - iPhone 12</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      :root { --ios-blue: #007AFF; --ios-green: #34c759; }
      body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; }

      .ui-header {
        position: fixed; top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
        padding: env(safe-area-inset-top) 20px 15px 20px;
        z-index: 1000; box-sizing: border-box;
        border-bottom: 0.5px solid rgba(255,255,255,0.2);
      }

      .input-container { display: flex; gap: 8px; flex-direction: column; }
      input { padding: 12px; border-radius: 10px; border: none; font-size: 16px; background: rgba(255,255,255,0.15); color: white; }
      
      #main-button { 
        padding: 14px; border-radius: 10px; background: var(--ios-blue); 
        color: white; border: none; font-weight: bold; font-size: 17px;
      }

      #guide-arrow {
        position: fixed; top: 55%; left: 50%;
        transform: translate(-50%, -50%);
        width: 80px; height: 80px;
        z-index: 500; display: none;
      }

      .data-footer {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.7); color: white;
        padding: 10px 20px env(safe-area-inset-bottom) 20px;
        font-size: 11px; z-index: 1000; display: flex; justify-content: space-between;
      }
    </style>
  </head>

  <body>
    <div class="ui-header">
      <div class="input-container">
        <input type="text" id="search-input" placeholder="Lugar o Coordenadas">
        <button id="main-button">BUSCAR Y ACTIVAR AR</button>
      </div>
    </div>

    <div id="guide-arrow">
      <svg viewBox="0 0 100 100">
        <path id="arrow-path" d="M50 5 L95 95 L50 75 L5 95 Z" fill="#34c759" stroke="white" stroke-width="3"/>
      </svg>
    </div>

    <div class="data-footer">
      <div><b>MI GPS:</b> <span id="my-coords">...</span></div>
      <div style="text-align: right;"><b>DESTINO:</b> <span id="dest-coords">---</span></div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-entity id="marker" gps-entity-place="latitude: 0; longitude: 0;" visible="false">
        <a-cylinder radius="4" height="1000" material="color: #34c759; opacity: 0.6"></a-cylinder>
      </a-entity>
      <a-camera id="camera" gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const mainBtn = document.getElementById('main-button');
      const arrow = document.getElementById('guide-arrow');
      const arrowPath = document.getElementById('arrow-path');
      const marker = document.getElementById('marker');
      let dLat, dLng;

      navigator.geolocation.watchPosition(p => {
        document.getElementById('my-coords').innerText = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
      });

      mainBtn.addEventListener('click', async () => {
        const scene = document.querySelector('a-scene');
        if (scene.suspended) scene.resume();
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          await DeviceOrientationEvent.requestPermission();
        }

        const query = document.getElementById('search-input').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        if (data.length > 0) {
          dLat = parseFloat(data[0].lat);
          dLng = parseFloat(data[0].lon);
          fijarDestino(dLat, dLng);
        }
      });

      function fijarDestino(lat, lng) {
        marker.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
        marker.setAttribute('visible', 'true');
        document.getElementById('dest-coords').innerText = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        arrow.style.display = 'block';
        iniciarNavegacion();
      }

      function iniciarNavegacion() {
        window.addEventListener('deviceorientation', (e) => {
          const cam = document.querySelector('[gps-camera]').components['gps-camera'];
          if (cam && cam.currentCoords) {
            const myPos = cam.currentCoords;
            
            // Distancia
            const R = 6371e3;
            const p1 = myPos.latitude * Math.PI/180;
            const p2 = dLat * Math.PI/180;
            const dp = (dLat - myPos.latitude) * Math.PI/180;
            const dl = (dLng - myPos.longitude) * Math.PI/180;
            const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
            const dist = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            mainBtn.innerText = Math.round(dist) + " METROS";

            // Flecha
            const y = Math.sin((dLng - myPos.longitude) * Math.PI/180) * Math.cos(dLat * Math.PI/180);
            const x = Math.cos(p1) * Math.sin(p2) - Math.sin(p1) * Math.cos(p2) * Math.cos((dLng - myPos.longitude) * Math.PI/180);
            const bearing = Math.atan2(y, x) * (180 / Math.PI);
            const heading = e.webkitCompassHeading || 0;
            let finalRot = (bearing - heading + 360) % 360;

            if (finalRot < 10 || finalRot > 350) {
              arrowPath.setAttribute('fill', '#007AFF');
              arrow.style.transform = `translate(-50%, -50%) rotate(0deg) scale(1.2)`;
            } else {
              arrowPath.setAttribute('fill', '#34c759');
              arrow.style.transform = `translate(-50%, -50%) rotate(${finalRot}deg) scale(1)`;
            }
          }
        }, true);
      }
    </script>
  </body>
</html>