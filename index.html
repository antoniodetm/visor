<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buscador AR iPhone 12 Pro</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background-color: #000; }
      
      /* Panel de control */
      .ui-panel {
        position: fixed; top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
        color: white; padding: env(safe-area-inset-top) 15px 15px 15px; 
        z-index: 100; box-sizing: border-box;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }

      .input-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
      .row { display: flex; gap: 8px; }
      
      input { 
        padding: 12px; border-radius: 10px; border: none; 
        font-size: 16px; background: rgba(255,255,255,0.15); color: white;
        width: 100%; box-sizing: border-box;
      }
      
      button { 
        padding: 15px; border-radius: 10px; background: #007AFF; 
        color: white; border: none; font-weight: bold; font-size: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }

      #status-msg { margin-top: 12px; font-size: 14px; color: #34c759; text-align: center; font-weight: bold; }
      .coords-label { font-size: 10px; color: #aaa; margin-bottom: -5px; margin-left: 2px; }
    </style>
  </head>

  <body>
    <div class="ui-panel">
      <div class="input-group">
        <input type="text" id="place-name" placeholder="Nombre del lugar (ej: Museo del Prado)">
        
        <div class="row">
          <div style="flex:1">
            <div class="coords-label">Latitud</div>
            <input type="number" id="lat-input" placeholder="40.416" step="any">
          </div>
          <div style="flex:1">
            <div class="coords-label">Longitud</div>
            <input type="number" id="lng-input" placeholder="-3.703" step="any">
          </div>
        </div>

        <button id="btn-search">BUSCAR Y ACTIVAR CMARA</button>
      </div>
      <div id="status-msg">Introduce destino y pulsa buscar</div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" 
             arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
      
      <a-entity id="target" gps-entity-place="latitude: 0; longitude: 0;" visible="false">
        <a-cylinder radius="3" height="500" material="color: #34c759; opacity: 0.5"></a-cylinder>
        <a-text value="DESTINO" align="center" scale="40 40 40" position="0 30 0" look-at="[gps-camera]"></a-text>
      </a-entity>

      <a-camera id="camera" gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const btn = document.getElementById('btn-search');
      const statusMsg = document.getElementById('status-msg');
      const target = document.getElementById('target');

      // Funci贸n principal de b煤squeda y activaci贸n
      btn.addEventListener('click', async function() {
        // 1. Activar sensores y c谩mara para iPhone
        const scene = document.querySelector('a-scene');
        if (scene.suspended) scene.resume();

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          await DeviceOrientationEvent.requestPermission();
        }

        const name = document.getElementById('place-name').value;
        const latInput = document.getElementById('lat-input').value;
        const lngInput = document.getElementById('lng-input').value;

        let finalLat, finalLng;

        // 2. Prioridad: Coordenadas manuales si existen, si no, buscar nombre
        if (latInput && lngInput) {
          finalLat = parseFloat(latInput);
          finalLng = parseFloat(lngInput);
          actualizarAR(finalLat, finalLng, "Coordenadas fijadas");
        } else if (name) {
          statusMsg.innerText = "Buscando nombre...";
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`);
            const data = await res.json();
            if (data.length > 0) {
              finalLat = parseFloat(data[0].lat);
              finalLng = parseFloat(data[0].lon);
              actualizarAR(finalLat, finalLng, ` ${data[0].display_name.split(',')[0]}`);
            } else {
              statusMsg.innerText = "Lugar no encontrado";
              statusMsg.style.color = "#ff3b30";
            }
          } catch (e) {
            statusMsg.innerText = "Error de conexi贸n";
          }
        }
      });

      function actualizarAR(lat, lng, msg) {
        target.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lng};`);
        target.setAttribute('visible', 'true');
        statusMsg.innerText = msg;
        statusMsg.style.color = "#34c759";
        
        // Peque帽o feedback visual en el bot贸n
        btn.innerText = "ACTUALIZAR DESTINO";
        btn.style.background = "#34c759";
      }

      // Mostrar mi ubicaci贸n actual para referencia
      navigator.geolocation.watchPosition((pos) => {
        console.log("GPS OK");
      }, null, { enableHighAccuracy: true });
    </script>
  </body>
</html>