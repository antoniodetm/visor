<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Finder - BrÃºjula Forzada</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      :root { --ios-blue: #007AFF; --ios-green: #34c759; }
      body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; }

      .ui-header {
        position: fixed; top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
        padding: 20px; z-index: 1000; box-sizing: border-box;
        border-bottom: 0.5px solid rgba(255,255,255,0.2);
      }
      .input-container { display: flex; gap: 10px; flex-direction: column; }
      input { padding: 14px; border-radius: 12px; border: none; background: rgba(255,255,255,0.15); color: white; font-size: 16px; }
      button { padding: 16px; border-radius: 12px; background: var(--ios-blue); color: white; border: none; font-weight: bold; cursor: pointer; }

      #guide-arrow {
        position: fixed; top: 55%; left: 50%;
        transform: translate(-50%, -50%) rotate(0deg);
        width: 110px; height: 110px;
        z-index: 500; display: none;
        filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      }

      .data-footer {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.8); color: white;
        padding: 15px 20px; font-size: 12px; z-index: 1000;
        display: flex; justify-content: space-between;
      }
      #status-text { text-align: center; font-weight: bold; color: var(--ios-green); margin-top: 8px; }
    </style>
  </head>

  <body>
    <div class="ui-header">
      <div class="input-container">
        <input type="text" id="search-input" placeholder="Ciudad, calle o coordenadas">
        <button id="main-button">ACTIVAR SENSORES Y BUSCAR</button>
      </div>
      <div id="status-text">GPS: Esperando seÃ±al...</div>
    </div>

    <div id="guide-arrow">
      <svg viewBox="0 0 100 100">
        <path id="arrow-path" d="M50 5 L90 95 L50 75 L10 95 Z" fill="#34c759" stroke="white" stroke-width="4"/>
      </svg>
    </div>

    <div class="data-footer">
      <div><b>MI RUMBO:</b> <span id="comp-val">0Â°</span></div>
      <div><b>AL OBJETIVO:</b> <span id="dest-val">--</span></div>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-entity id="marker" gps-entity-place="latitude: 0; longitude: 0;" visible="false">
        <a-cylinder radius="4" height="500" material="color: #007AFF; opacity: 0.5"></a-cylinder>
      </a-entity>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const statusText = document.getElementById('status-text');
      const compVal = document.getElementById('comp-val');
      const arrow = document.getElementById('guide-arrow');
      const arrowPath = document.getElementById('arrow-path');
      
      let myLat, myLng, dLat, dLng;
      let userHeading = 0;

      // 1. GPS Continuo
      navigator.geolocation.watchPosition(p => {
        myLat = p.coords.latitude;
        myLng = p.coords.longitude;
        statusText.innerText = "GPS Conectado âœ…";
      }, (err) => {
        statusText.innerText = "Error GPS: Activa la ubicaciÃ³n";
      }, { enableHighAccuracy: true });

      // 2. Activar Sensores (BotÃ³n)
      document.getElementById('main-button').addEventListener('click', async () => {
        // Forzar permisos en iOS 13+
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission !== 'granted') {
              alert("Debes permitir el acceso a los sensores para usar la brÃºjula.");
              return;
            }
          } catch (e) { console.error(e); }
        }

        // Activar eventos de orientaciÃ³n
        window.addEventListener('deviceorientation', handleOrientation, true);
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);

        // Buscar lugar
        const query = document.getElementById('search-input').value;
        if (!query) return;

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
          const data = await res.json();
          if (data.length > 0) {
            dLat = parseFloat(data[0].lat);
            dLng = parseFloat(data[0].lon);
            document.getElementById('marker').setAttribute('gps-entity-place', `latitude: ${dLat}; longitude: ${dLng};`);
            document.getElementById('marker').setAttribute('visible', 'true');
            arrow.style.display = 'block';
            statusText.innerText = "Buscando: " + data[0].display_name.split(',')[0];
          }
        } catch (e) { alert("Error en la bÃºsqueda"); }
      });

      // 3. LÃ³gica de BrÃºjula y Flecha
      function handleOrientation(e) {
        // Detectar si es iOS o Android
        userHeading = e.webkitCompassHeading || (360 - e.alpha);
        
        if (userHeading === undefined || isNaN(userHeading)) return;
        
        compVal.innerText = Math.floor(userHeading) + "Â°";

        if (dLat && myLat) {
          // CÃ¡lculo del rumbo (Bearing)
          const rad = Math.PI / 180;
          const y = Math.sin((dLng - myLng) * rad) * Math.cos(dLat * rad);
          const x = Math.cos(myLat * rad) * Math.sin(dLat * rad) -
                    Math.sin(myLat * rad) * Math.cos(dLat * rad) * Math.cos((dLng - myLng) * rad);
          
          let bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
          
          // La flecha debe apuntar a: Rumbo destino - Hacia donde mira el usuario
          let arrowRotation = (bearing - userHeading + 360) % 360;
          
          arrow.style.transform = `translate(-50%, -50%) rotate(${arrowRotation}deg)`;
          document.getElementById('dest-val').innerText = Math.floor(bearing) + "Â°";

          // Feedback visual: Si estÃ¡s cerca del Ã¡ngulo correcto (Â±15 grados)
          const diff = ((arrowRotation + 180) % 360) - 180;
          if (Math.abs(diff) < 15) {
            arrowPath.setAttribute('fill', '#007AFF'); // Azul cuando aciertas
            statusText.innerText = "Â¡MIRA AQUÃ! ðŸŽ¯";
          } else {
            arrowPath.setAttribute('fill', '#34c759'); // Verde mientras buscas
          }
        }
      }
    </script>
  </body>
</html>