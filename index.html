<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Buscador AR con Brújula</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; }
      
      /* Buscador */
      .search-panel {
        position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
        z-index: 1000; width: 85%; background: rgba(0,0,0,0.8);
        padding: 10px; border-radius: 12px; display: flex; gap: 8px;
      }
      input { flex: 1; border: none; border-radius: 6px; padding: 10px; font-size: 16px; }
      button { background: #007AFF; color: white; border: none; border-radius: 6px; padding: 0 15px; font-weight: bold; }

      /* Brújula y Flecha */
      .guide-container {
        position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
        z-index: 1000; text-align: center; color: white;
      }
      #arrow {
        width: 80px; height: 80px;
        transition: transform 0.2s ease-out;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
      }
      #dist-text { background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
    </style>
  </head>

  <body>
    <div class="search-panel">
      <input type="text" id="placeName" placeholder="¿A dónde quieres ir?">
      <button onclick="buscarLugar()">IR</button>
    </div>

    <div class="guide-container" id="guideUI" style="display: none;">
      <svg id="arrow" viewBox="0 0 100 100">
        <polygon points="50,5 95,95 50,75 5,95" fill="#00FF00" />
      </svg>
      <div id="dist-text">Calculando...</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; trackingMethod: best;"
    >
      <a-text id="marker" value="" look-at="[gps-camera]" scale="50 50 50" gps-entity-place="latitude: 0; longitude: 0;" color="yellow"></a-text>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      let destLat, destLon;
      const arrow = document.getElementById('arrow');
      const distText = document.getElementById('dist-text');

      async function buscarLugar() {
        const query = document.getElementById('placeName').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
        const data = await res.json();

        if (data.length > 0) {
          destLat = parseFloat(data[0].lat);
          destLon = parseFloat(data[0].lon);
          
          document.getElementById('marker').setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLon};`);
          document.getElementById('marker').setAttribute('value', data[0].display_name.split(',')[0]);
          document.getElementById('guideUI').style.display = 'block';
        }
      }

      // Lógica de la Brújula
      window.addEventListener('deviceorientationabsolute', handlerOrientation, true);
      // Para iPhones modernos
      window.addEventListener('deviceorientation', handlerOrientation, true);

      function handlerOrientation(event) {
        if (!destLat) return;

        // 1. Obtener rumbo del usuario (norte magnético)
        let compass = event.webkitCompassHeading || (360 - event.alpha);
        
        // 2. Obtener posición actual
        navigator.geolocation.getCurrentPosition((pos) => {
          const userLat = pos.coords.latitude;
          const userLon = pos.coords.longitude;

          // 3. Calcular ángulo hacia el destino (Bearing)
          const y = Math.sin(toRadians(destLon - userLon)) * Math.cos(toRadians(destLat));
          const x = Math.cos(toRadians(userLat)) * Math.sin(toRadians(destLat)) -
                    Math.sin(toRadians(userLat)) * Math.cos(toRadians(destLat)) * Math.cos(toRadians(destLon - userLon));
          let bearing = toDegrees(Math.atan2(y, x));
          bearing = (bearing + 360) % 360;

          // 4. Rotar la flecha: Diferencia entre hacia donde miro y el destino
          const arrowRotation = bearing - compass;
          arrow.style.transform = `rotate(${arrowRotation}deg)`;

          // 5. Distancia
          const d = calcularDistancia(userLat, userLon, destLat, destLon);
          distText.innerText = d > 1 ? `${d.toFixed(2)} km` : `${(d*1000).toFixed(0)} metros`;
        });
      }

      function toRadians(deg) { return deg * (Math.PI / 180); }
      function toDegrees(rad) { return rad * (180 / Math.PI); }
      
      function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = toRadians(lat2-lat1);
        const dLon = toRadians(lon2-lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }
    </script>
  </body>
</html>